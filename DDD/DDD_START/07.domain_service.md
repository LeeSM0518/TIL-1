# 07. 도메인 서비스

<img src="https://user-images.githubusercontent.com/42791260/44824909-eedbc780-ac42-11e8-8dc2-c4b806b2b073.png" width="50%">

[![npm](https://img.shields.io/badge/version-2018.35-brightgreen.svg)]()

## 여러 애그리거트가 필요한 기능

도메인 영역의 코드를 작성하다 보면 한 애그리거트로 기능을 구현할 수 없을 때가 있습니다. 대표적인 예가 결제 금액 계산 로직입니다. 실제로 결제 금액을 계산할 때 다음과 같은 애그리거트가 필요할 것입니다.

* 상품 애그리거트
* 주문 애그리거트
* 할인 쿠폰 애그리거트
* 회원 애그리거트



만약 결제 금액 계산에 필요한 로직을 주문 애그리거트가 구현한다고 가정해봅시다. 이 경우 애그리거트는 자신의 챔임 범위를 넘어서는 기능을 구현 하기 때문에 코드가 길어지고 외부에 대한 의존이 높아지게 됩니다. 이는 코드를 복잡하게 만들고 애그리거트의 범위를 넘어서는 도메인 개념이 들어오므로써 기존 애그리거트의 의미를 잃어버리게 만듭니다. 

이러한 문제를 해결하는 방법은 바로 **도메인 서비스**를 별도로 구현하는 것입니다.




## 도메인 서비스

할인 금액 규칙 계산처럼 한 애그리거트에 넣기 애매한 도메인 개념을 구현하려면 애그리겈트에 억지로 넣기보다는 도메인 서비스를 이용해서 도메인 개념을 명시적으로 드러내면 됩니다. 응용 영역의 서비스가 응용 로직을 다룬다면 도메인 서비스는 도메인 로직을 다룹니다. 

도메인 서비스가 도메인 영역의 애그리거트나 밸류와 같은 다른 구성요소와 비교할때 다른 점이 있다면 그것은 바로 상태 없이 로직만 구현한다는 점입니다. 도메인 서비스를 구현하는 데 필요한 상태는 애그리거트나 다른 방법으로 전달받습니다. 할인 금액 규칙 계산에 대한 도메인 서비스를 구현한 코드입니다.

```java
public class DiscountCalculationService {
    
    public Money calculateDiscountAmounts(List<OrderLine> orderLines, List<Coupon> coupons, MemberGrade grade) {
        Money couponDiscount = coupons
            					.stream()
            					.map(coupon -> calculateDiscount(coupon))
            					.reduce(Money(0), (v1, v2) -> v1.add(v2));
        
        Money membershipDiscount = caculateDiscount(orderer.getMember().getGrade());
        
        return couponDiscount.add(membershipDiscount);
    }
    
    private Money calculateDiscount(Coupon coupon) {
        ...
    }
    
    private Money calculateDiscount(MemberGrade grade) {
        ...
    }
}
```



할인 계산 서비스를 사용하는 주체는 애그리거트가 될 수도 있고 응용 서비스가 될 수도 있습니다. DiscountCalculation-Service를 다음과 같이 애그리거트의 결제 금액 계산 기능에 전달하면 사용 주체는 애그리거트가 됩니다.

~~~java
public class Order {
    
    public void calculateAmounts(DiscountCalculationService disCalSvc, MemberGrade grade) {
        Money totalAmounts = getTotalAmounts();
        Money discountAmounts = disCalSvc.calculateDiscountAmounts(this.orderLines, this.coupons, grade);
        this.paymentAmounts = totalAmounts.minus(discountAmounts);
    }
    ...
}
~~~



> 애그리거트 객체에 도메인 서비스를 전달하는 것은 응용 서비스의 책임이다.



### 도메인 서비스의 패키지 위치

### 도메인 서비스의 인터페이스와 클래스

